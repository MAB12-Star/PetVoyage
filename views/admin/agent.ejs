<% layout('layouts/boilerplate') %>
<% if (!user || user.role !== 'admin') { %>
  <div class="container py-5">
    <h1 class="h4 mb-3">403 – Admins only</h1>
    <p class="text-muted">You do not have permission to access this page.</p>
    <a class="btn btn-outline-secondary" href="/">Back to home</a>
  </div>
  <% return; %>
<% } %>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="fw-bold mb-1">Country Regulations Agent</h1>
      <div class="text-muted">Run the pipeline to research → extract → validate → publish country regulations.</div>
    </div>
    <a class="btn btn-outline-secondary" href="/admin">Back to Admin</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">

        <!-- Country -->
        <div class="col-lg-6">
          <label class="form-label fw-semibold">Destination Country</label>
          <select id="countryName" class="form-select">
            <option value="">Loading countries…</option>
          </select>
          <div class="form-text">Pulled from <code>destinationCountry</code> values in MongoDB.</div>
        </div>

        <!-- Research mode -->
        <div class="col-lg-6">
          <label class="form-label fw-semibold">Research Mode</label>
          <select id="researchMode" class="form-select">
            <option value="seed_first" selected>Seed-first (use DB links; broaden only if weak)</option>
            <option value="provided_only">Provided links only (no broad web)</option>
            <option value="deep">Deep (seed + always broaden web)</option>
          </select>
          <div class="form-text">
            Use <code>provided_only</code> when you want to control sources strictly.
          </div>
        </div>

        <!-- Manual URLs -->
        <div class="col-12">
          <label class="form-label fw-semibold">Manual URLs (one per line)</label>
          <textarea id="manualUrls" class="form-control" rows="5" placeholder="https://..."></textarea>
          <div class="form-text">
            Used in <code>provided_only</code> mode (required), or as extra context for other modes.
          </div>
        </div>

        <!-- Options -->
        <div class="col-12 d-flex align-items-center gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="wantExplain" />
            <label class="form-check-label" for="wantExplain">
              Explain validation failures (slower)
            </label>
          </div>

          <div class="ms-auto d-flex gap-2">
            <button id="runBtn" class="btn btn-primary">
              Run (Preview)
            </button>
            <button id="publishBtn" class="btn btn-success" disabled>
              Publish
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

 <div class="row g-3">
  <!-- Status / Logs -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Status</div>
      <div class="card-body">
        <div id="status" class="mb-2">Ready.</div>

        <div class="small text-muted mb-2">Live updates:</div>
        <pre
          id="meta"
          style="white-space:pre-wrap;margin:0;height:240px;overflow:auto;background:#fafafa;border:1px solid #eee;padding:.5rem;border-radius:.5rem;"
        >(none)</pre>
      </div>
    </div>
  </div>

  <!-- Output -->
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Output</span>
        <button id="copyBtn" class="btn btn-sm btn-outline-secondary" disabled>Copy JSON</button>
      </div>
      <div class="card-body">
        
        <div id="out" class="border rounded bg-white" style="min-height:400px;">
  <div class="text-muted p-3">(nothing yet)</div>
</div>

      </div>
    </div>
  </div>
</div>


<script>
  let es = null;
  let lastFinalDoc = null;

  const $ = (id) => document.getElementById(id);

  function setStatus(text, kind = "info") {
    const el = $("status");
    el.className = "";
    if (kind === "ok") el.classList.add("text-success", "fw-semibold");
    if (kind === "err") el.classList.add("text-danger", "fw-semibold");
    if (kind === "warn") el.classList.add("text-warning", "fw-semibold");
    el.textContent = text;
  }

  function appendLog(line) {
    const metaEl = $("meta");
    metaEl.textContent += (metaEl.textContent && metaEl.textContent !== "(none)" ? "\n" : "") + line;
    metaEl.scrollTop = metaEl.scrollHeight;
  }

  async function renderPreview(finalDoc) {
    const outEl = $("out");

    // Put iframe in place immediately
    outEl.innerHTML = `
      <iframe
        id="previewFrame"
        style="width:100%;height:800px;border:none;"
        srcdoc="Loading preview…">
      </iframe>
    `;

    const iframe = $("previewFrame");

    const resp = await fetch("/admin/agent/preview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ finalDoc })
    });

    if (!resp.ok) {
      const errText = await resp.text();
      outEl.textContent = `Preview failed (${resp.status}):\n\n${errText}`;
      return;
    }

    iframe.srcdoc = await resp.text();
  }

  function startAgentStream({ countryName, researchMode, manualUrls, wantExplain, dryRun }) {
    const copyBtn = $("copyBtn");
    const publishBtn = $("publishBtn");

    // reset UI
    lastFinalDoc = null;
    setStatus("Starting…", "info");
    $("meta").textContent = "";
    $("out").innerHTML = `<div class="text-muted p-3">(running...)</div>`;
    if (copyBtn) copyBtn.disabled = true;
    if (publishBtn) publishBtn.disabled = true;

    // close previous stream if any
    if (es) es.close();

    const qs = new URLSearchParams({
      countryName,
      researchMode: researchMode || "seed_first",
      wantExplain: wantExplain ? "true" : "false",
      dryRun: dryRun ? "true" : "false",
      manualUrls: manualUrls || ""
    });

    es = new EventSource(`/admin/agent/stream?${qs.toString()}`);

    es.addEventListener("progress", (e) => {
      const data = JSON.parse(e.data || "{}");
      const msg = data.message || "Working…";
      setStatus(msg, "info");
      appendLog(`• ${msg}`);
    });

    es.addEventListener("status", (e) => {
      // optional if your backend emits "status" events too
      const data = JSON.parse(e.data || "{}");
      const msg = data.message || "Working…";
      setStatus(msg, "info");
    });

    es.addEventListener("done", async (e) => {
      const result = JSON.parse(e.data || "{}");

      // Expect result.finalDoc from backend
      lastFinalDoc = result?.finalDoc || null;

      if (!lastFinalDoc) {
        setStatus("Done, but no finalDoc returned.", "warn");
        appendLog("✅ Done (no finalDoc).");
        $("out").textContent = JSON.stringify(result, null, 2);
        if (es) es.close();
        es = null;
        return;
      }

      setStatus(dryRun ? "✅ Preview complete" : "✅ Published", "ok");
      appendLog("✅ Done.");

      // Render HTML preview (keeps the UI nice)
      await renderPreview(lastFinalDoc);

      // Enable Copy JSON always when we have finalDoc
      if (copyBtn) copyBtn.disabled = false;

      // Only enable Publish after a successful preview (dryRun)
      if (publishBtn) publishBtn.disabled = !dryRun;

      if (es) es.close();
      es = null;
    });

    es.addEventListener("error", () => {
      setStatus("❌ Stream error (see server logs).", "err");
      appendLog("❌ Stream error (see server logs).");
      if (es) es.close();
      es = null;
    });
  }

  async function loadCountries() {
    try {
      const res = await fetch("/admin/agent/countries", { headers: { "Accept": "application/json" } });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Failed to load countries");

      const sel = $("countryName");
      sel.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a destination country…";
      sel.appendChild(placeholder);

      (data.countries || []).forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });

      setStatus("Countries loaded.", "ok");
      $("meta").textContent = "(none)";
    } catch (e) {
      setStatus("Failed to load countries: " + e.message, "err");
      const sel = $("countryName");
      sel.innerHTML = '<option value="">(error loading countries)</option>';
    }
  }

  function getFormPayload() {
    return {
      countryName: $("countryName")?.value || "",
      researchMode: $("researchMode")?.value || "seed_first",
      manualUrls: $("manualUrls")?.value || "",
      wantExplain: $("wantExplain")?.checked || false
    };
  }

  // Run (Preview)
  $("runBtn")?.addEventListener("click", () => {
    const p = getFormPayload();

    if (!p.countryName) {
      setStatus("Pick a country first.", "warn");
      return;
    }

    if (p.researchMode === "provided_only" && !p.manualUrls.trim()) {
      setStatus("provided_only mode requires manual URLs.", "warn");
      return;
    }

    startAgentStream({ ...p, dryRun: true });
  });

  // Publish (runs the pipeline with dryRun=false)
  $("publishBtn")?.addEventListener("click", () => {
    const p = getFormPayload();

    if (!p.countryName) {
      setStatus("Pick a country first.", "warn");
      return;
    }

    // Optional: you can require that they preview first
    // if (!lastFinalDoc) { setStatus("Run Preview first.", "warn"); return; }

    startAgentStream({ ...p, dryRun: false });
  });

  // Copy JSON (ONLY finalDoc)
  $("copyBtn")?.addEventListener("click", async () => {
    if (!lastFinalDoc) return;
    await navigator.clipboard.writeText(JSON.stringify(lastFinalDoc, null, 2));
    setStatus("Copied finalDoc JSON to clipboard.", "ok");
  });

  loadCountries();
</script>

