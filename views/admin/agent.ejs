<% layout('layouts/boilerplate') %>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="fw-bold mb-1">Country Regulations Agent</h1>
      <div class="text-muted">Run the pipeline to research → extract → validate → publish country regulations.</div>
    </div>
    <a class="btn btn-outline-secondary" href="/admin">Back to Admin</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">

        <!-- Country -->
        <div class="col-lg-6">
          <label class="form-label fw-semibold">Destination Country</label>
          <select id="countryName" class="form-select">
            <option value="">Loading countries…</option>
          </select>
          <div class="form-text">Pulled from <code>destinationCountry</code> values in MongoDB.</div>
        </div>

        <!-- Research mode -->
        <div class="col-lg-6">
          <label class="form-label fw-semibold">Research Mode</label>
          <select id="researchMode" class="form-select">
            <option value="seed_first" selected>Seed-first (use DB links; broaden only if weak)</option>
            <option value="provided_only">Provided links only (no broad web)</option>
            <option value="deep">Deep (seed + always broaden web)</option>
          </select>
          <div class="form-text">
            Use <code>provided_only</code> when you want to control sources strictly.
          </div>
        </div>

        <!-- Manual URLs -->
        <div class="col-12">
          <label class="form-label fw-semibold">Manual URLs (one per line)</label>
          <textarea id="manualUrls" class="form-control" rows="5" placeholder="https://..."></textarea>
          <div class="form-text">
            Used in <code>provided_only</code> mode (required), or as extra context for other modes.
          </div>
        </div>

        <!-- Options -->
        <div class="col-12 d-flex align-items-center gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="wantExplain" />
            <label class="form-check-label" for="wantExplain">
              Explain validation failures (slower)
            </label>
          </div>

          <div class="ms-auto d-flex gap-2">
            <button id="runBtn" class="btn btn-primary">
              Run (Preview)
            </button>
            <button id="publishBtn" class="btn btn-success" disabled>
              Publish
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

 <div class="row g-3">
  <!-- Status / Logs -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Status</div>
      <div class="card-body">
        <div id="status" class="mb-2">Ready.</div>

        <div class="small text-muted mb-2">Updates:</div>
        <pre
          id="meta"
          style="white-space:pre-wrap;margin:0;height:240px;overflow:auto;background:#fafafa;border:1px solid #eee;padding:.5rem;border-radius:.5rem;"
        >(none)</pre>
      </div>
    </div>
  </div>

  <!-- Output -->
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Output</span>
        <button id="copyBtn" class="btn btn-sm btn-outline-secondary" disabled>Copy JSON</button>
      </div>
      <div class="card-body">

        <div id="out" class="border rounded bg-white" style="min-height:400px;">
          <div class="text-muted p-3">(nothing yet)</div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  let lastFinalDoc = null;

  const $ = (id) => document.getElementById(id);

  function setStatus(text, kind = "info") {
    const el = $("status");
    el.className = "";
    if (kind === "ok") el.classList.add("text-success", "fw-semibold");
    if (kind === "err") el.classList.add("text-danger", "fw-semibold");
    if (kind === "warn") el.classList.add("text-warning", "fw-semibold");
    el.textContent = text;
  }

  function appendLog(line) {
    const metaEl = $("meta");
    metaEl.textContent += (metaEl.textContent && metaEl.textContent !== "(none)" ? "\n" : "") + line;
    metaEl.scrollTop = metaEl.scrollHeight;
  }

  function resetUiForRun() {
    lastFinalDoc = null;
    $("meta").textContent = "";
    $("out").innerHTML = `<div class="text-muted p-3">(running...)</div>`;
    $("copyBtn").disabled = true;
    $("publishBtn").disabled = true;
  }

  async function renderPreview(finalDoc) {
    const outEl = $("out");

    // Put iframe in place immediately
    outEl.innerHTML = `
      <iframe
        id="previewFrame"
        style="width:100%;height:800px;border:none;"
        srcdoc="Loading preview…">
      </iframe>
    `;

    const iframe = $("previewFrame");

    const resp = await fetch("/admin/agent/preview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ finalDoc })
    });

    if (!resp.ok) {
      const errText = await resp.text();
      outEl.textContent = `Preview failed (${resp.status}):\n\n${errText}`;
      return;
    }

    iframe.srcdoc = await resp.text();
  }

  function getFormPayload() {
    return {
      countryName: $("countryName")?.value || "",
      researchMode: $("researchMode")?.value || "seed_first",
      manualUrls: $("manualUrls")?.value || "",
      wantExplain: $("wantExplain")?.checked || false
    };
  }

  // ✅ Preview runner (non-SSE)
  async function runPreview(p) {
    resetUiForRun();
    setStatus("Running preview…", "info");

    appendLog(`• Starting agent for ${p.countryName}`);
    appendLog(`• Mode: ${p.researchMode}`);
    if (p.researchMode === "provided_only") appendLog(`• Using manual URLs only`);

    try {
      const resp = await fetch("/admin/agent/run", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(p)
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || data?.ok === false) {
        const msg = data?.error || data?.message || `Run failed (${resp.status})`;
        setStatus("❌ " + msg, "err");
        appendLog("❌ " + msg);
        $("out").textContent = JSON.stringify(data, null, 2);
        return;
      }

      lastFinalDoc = data?.finalDoc || null;

      if (!lastFinalDoc) {
        setStatus("Done, but no finalDoc returned.", "warn");
        appendLog("✅ Done (no finalDoc).");
        $("out").textContent = JSON.stringify(data, null, 2);
        return;
      }

      setStatus("✅ Preview complete", "ok");
      appendLog("✅ Done.");
      await renderPreview(lastFinalDoc);

      $("copyBtn").disabled = false;
      $("publishBtn").disabled = false; // enable publish after successful preview
    } catch (e) {
      setStatus("❌ " + (e?.message || "Unknown error"), "err");
      appendLog("❌ " + (e?.message || "Unknown error"));
    }
  }

  // ✅ Publish runner (non-SSE)
  async function publish(p) {
    // Optional: require preview first
    // if (!lastFinalDoc) { setStatus("Run Preview first.", "warn"); return; }

    $("publishBtn").disabled = true;
    setStatus("Publishing…", "info");
    appendLog("• Publishing…");

    try {
      const resp = await fetch("/admin/agent/publish", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(p)
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || data?.ok === false) {
        const msg = data?.error || data?.message || `Publish failed (${resp.status})`;
        setStatus("❌ " + msg, "err");
        appendLog("❌ " + msg);
        $("out").textContent = JSON.stringify(data, null, 2);
        $("publishBtn").disabled = false;
        return;
      }

      // many pipelines still return finalDoc on publish; if so, preview it:
      if (data?.finalDoc) {
        lastFinalDoc = data.finalDoc;
        await renderPreview(lastFinalDoc);
        $("copyBtn").disabled = false;
      }

      setStatus("✅ Published", "ok");
      appendLog("✅ Published.");
    } catch (e) {
      setStatus("❌ " + (e?.message || "Unknown error"), "err");
      appendLog("❌ " + (e?.message || "Unknown error"));
      $("publishBtn").disabled = false;
    }
  }

  async function loadCountries() {
    try {
      const res = await fetch("/admin/agent/countries", { headers: { "Accept": "application/json" } });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Failed to load countries");

      const sel = $("countryName");
      sel.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a destination country…";
      sel.appendChild(placeholder);

      (data.countries || []).forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });

      setStatus("Countries loaded.", "ok");
      $("meta").textContent = "(none)";
    } catch (e) {
      setStatus("Failed to load countries: " + e.message, "err");
      const sel = $("countryName");
      sel.innerHTML = '<option value="">(error loading countries)</option>';
    }
  }

  // Run (Preview)
  $("runBtn")?.addEventListener("click", async () => {
    const p = getFormPayload();

    if (!p.countryName) {
      setStatus("Pick a country first.", "warn");
      return;
    }

    if (p.researchMode === "provided_only" && !p.manualUrls.trim()) {
      setStatus("provided_only mode requires manual URLs.", "warn");
      return;
    }

    await runPreview(p);
  });

  // Publish
  $("publishBtn")?.addEventListener("click", async () => {
    const p = getFormPayload();

    if (!p.countryName) {
      setStatus("Pick a country first.", "warn");
      return;
    }

    await publish(p);
  });

  // Copy JSON (ONLY finalDoc)
  $("copyBtn")?.addEventListener("click", async () => {
    if (!lastFinalDoc) return;
    await navigator.clipboard.writeText(JSON.stringify(lastFinalDoc, null, 2));
    setStatus("Copied finalDoc JSON to clipboard.", "ok");
  });

  loadCountries();
</script>
