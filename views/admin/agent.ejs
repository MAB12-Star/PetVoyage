<% layout('layouts/boilerplate') %>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="fw-bold mb-1">Country Regulations Agent</h1>
      <div class="text-muted">Run research ‚Üí extract ‚Üí validate ‚Üí publish, and chat to improve accuracy.</div>
    </div>
    <a class="btn btn-outline-secondary" href="/admin">Back to Admin</a>
  </div>

  <!-- Top controls -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-lg-6">
          <label class="form-label fw-semibold">Destination Country</label>
          <select id="countryName" class="form-select">
            <option value="">Loading countries‚Ä¶</option>
          </select>
          <div class="form-text">Pulled from <code>destinationCountry</code> values in MongoDB.</div>
        </div>

        <div class="col-lg-6">
          <label class="form-label fw-semibold">Research Mode</label>
          <select id="researchMode" class="form-select">
            <option value="seed_first" selected>Seed-first (use DB links; broaden only if weak)</option>
            <option value="provided_only">Provided links only (no broad web)</option>
            <option value="deep">Deep (seed + always broaden web)</option>
          </select>
          <div class="form-text">
            Use <code>provided_only</code> when you want strict source control.
          </div>
        </div>

        <div class="col-12">
          <label class="form-label fw-semibold">Manual URLs (one per line)</label>
          <textarea id="manualUrls" class="form-control" rows="5" placeholder="https://..."></textarea>
          <div class="form-text">
            Required for <code>provided_only</code>. Also used as extra context for other modes.
          </div>
        </div>

        <div class="col-12 d-flex align-items-center gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="wantExplain" />
            <label class="form-check-label" for="wantExplain">
              Explain validation failures (slower)
            </label>
          </div>

          <div class="ms-auto d-flex gap-2">
            <button id="runBtn" class="btn btn-primary">Run (Preview)</button>
            <button id="publishBtn" class="btn btn-success" disabled>Publish</button>
            <button id="stopBtn" class="btn btn-outline-danger" disabled>Stop</button>
            <button id="loadAuditBtn" class="btn btn-outline-secondary">Load Last Audit</button>

            <div class="form-check form-switch ms-2">
              <input class="form-check-input" type="checkbox" id="reuseAuditToggle" />
              <label class="form-check-label" for="reuseAuditToggle">Reuse last audit for Preview</label>
            </div>


          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom: Output (left) + Status/Chat (right) -->
  <div class="row g-3">
    <!-- LEFT: Output -->
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span>Output</span>
          <button id="copyBtn" class="btn btn-sm btn-outline-secondary" disabled>Copy JSON</button>
        </div>
        <div class="card-body">
          <div id="out" class="border rounded bg-white" style="min-height:700px;">
            <div class="text-muted p-3">(nothing yet)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Status + Chat (sticky) -->
    <div class="col-lg-4">
      <div style="position: sticky; top: 90px;">
        <div class="card shadow-sm mb-3">
          <div class="card-header fw-semibold">Status</div>
          <div class="card-body">
            <div id="status" class="mb-2">Ready.</div>

            <div class="small text-muted mb-2">Live updates:</div>
            <pre id="meta"
              style="white-space:pre-wrap;margin:0;height:220px;overflow:auto;background:#fafafa;border:1px solid #eee;padding:.5rem;border-radius:.5rem;"
            >(none)</pre>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header fw-semibold">Chat with Agent</div>
          <div class="card-body">
            <div id="chatThread" class="border rounded p-2 mb-2" style="height:260px;overflow:auto;background:#fff;">
              <div class="text-muted small">
                Ask: ‚ÄúWhat‚Äôs missing?‚Äù ‚ÄúFind official links for X.‚Äù ‚ÄúMexico requires rabies‚Äîconfirm and update.‚Äù
              </div>
            </div>

            <textarea id="chatInput" class="form-control mb-2" rows="3" placeholder="Type to the agent‚Ä¶"></textarea>

            <div class="d-flex gap-2 align-items-center flex-wrap">
  <button id="chatSendBtn" class="btn btn-outline-primary btn-sm">Send</button>
  <button id="applyUrlsBtn" class="btn btn-outline-success btn-sm" disabled>Apply suggested URLs</button>

  <!-- PDF upload -->
  <label class="btn btn-outline-secondary btn-sm mb-0">
    Upload PDF
    <input
      type="file"
      id="pdfUploadInput"
      accept="application/pdf"
      hidden
    />
  </label>
</div>

<div id="pdfUploadStatus" class="small text-muted mt-1"></div>


            <div id="chatHints" class="small text-muted mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
let lastAuditId = null;

async function loadLastAudit() {
  const p = getFormPayload();
  if (!p.countryName) { setStatus("Pick a country first.", "warn"); return null; }

  setStatus("Loading last audit‚Ä¶", "info");
  const resp = await fetch("/admin/agent/audit/latest?countryName=" + encodeURIComponent(p.countryName), {
    headers: { "Accept": "application/json" }
  });

  const data = await resp.json().catch(() => ({}));
  if (!resp.ok || data?.ok === false) {
    setStatus("Failed to load audit: " + (data?.error || resp.status), "err");
    return null;
  }

  if (!data.audit) {
    setStatus("No audit found for this country yet.", "warn");
    return null;
  }

  lastAuditId = data.audit.id || null;

  const doc = data.audit.finalDoc || data.audit.draft;
  if (!doc) {
    setStatus("Audit exists but has no draft/finalDoc.", "warn");
    return null;
  }

  lastFinalDoc = doc;
  $("out").textContent = JSON.stringify(doc, null, 2);
  $("copyBtn").disabled = false;
  $("publishBtn").disabled = false;

  appendLog(`‚úÖ Loaded audit ${lastAuditId}`);
  setStatus("‚úÖ Audit loaded", "ok");
  return doc;
}

  let lastFinalDoc = null;
  let lastSuggestedUrls = [];
  let es = null;

  function setStatus(text, kind = "info") {
    const el = $("status");
    el.className = "";
    if (kind === "ok") el.classList.add("text-success", "fw-semibold");
    if (kind === "err") el.classList.add("text-danger", "fw-semibold");
    if (kind === "warn") el.classList.add("text-warning", "fw-semibold");
    el.textContent = text;
  }

  function appendLog(line) {
    const metaEl = $("meta");
    if (metaEl.textContent === "(none)") metaEl.textContent = "";
    metaEl.textContent += (metaEl.textContent ? "\n" : "") + line;
    metaEl.scrollTop = metaEl.scrollHeight;
  }

  function resetUiForRun() {
    lastFinalDoc = null;
    lastSuggestedUrls = [];
    $("applyUrlsBtn").disabled = true;
    $("chatHints").textContent = "";
    $("meta").textContent = "";
    $("out").innerHTML = `<div class="text-muted p-3">(running...)</div>`;
    $("copyBtn").disabled = true;
    $("publishBtn").disabled = true;
  }

  function getFormPayload() {
    return {
      countryName: $("countryName")?.value || "",
      researchMode: $("researchMode")?.value || "seed_first",
      manualUrls: $("manualUrls")?.value || "",
      wantExplain: $("wantExplain")?.checked || false
    };
  }

  async function renderPreview(finalDoc) {
    const outEl = $("out");
    outEl.innerHTML = `
      <iframe id="previewFrame" style="width:100%;height:900px;border:none;" srcdoc="Loading preview‚Ä¶"></iframe>
    `;

    const resp = await fetch("/admin/agent/preview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ finalDoc })
    });

    if (!resp.ok) {
      const errText = await resp.text();
      outEl.textContent = `Preview failed (${resp.status}):\n\n${errText}`;
      return;
    }

    $("previewFrame").srcdoc = await resp.text();
  }

  function stopStream() {
    if (es) {
      try { es.close(); } catch {}
      es = null;
    }
    $("stopBtn").disabled = true;
  }

  async function runPreviewSSE(p) {
    resetUiForRun();

    if (!p.countryName) { setStatus("Pick a country first.", "warn"); return; }
    if (p.researchMode === "provided_only" && !p.manualUrls.trim()) {
      setStatus("provided_only mode requires manual URLs.", "warn");
      return;
    }

    setStatus("Running preview (streaming)‚Ä¶", "info");
    appendLog(`‚Ä¢ Starting agent for ${p.countryName}`);
    appendLog(`‚Ä¢ Mode: ${p.researchMode}`);
    if (p.researchMode === "provided_only") appendLog(`‚Ä¢ Using manual URLs only`);

    stopStream();
    $("stopBtn").disabled = false;

    const qs = new URLSearchParams({
      countryName: p.countryName,
      researchMode: p.researchMode,
      wantExplain: String(!!p.wantExplain),
      dryRun: "true",
      manualUrls: p.manualUrls
    });

    es = new EventSource("/admin/agent/stream?" + qs.toString());

    es.addEventListener("status", (ev) => {
      const data = JSON.parse(ev.data || "{}");
      if (data.message) appendLog("‚Ä¢ " + data.message);
    });

    es.addEventListener("progress", (ev) => {
      const data = JSON.parse(ev.data || "{}");
      if (data.message) appendLog("‚Ä¢ " + data.message);
    });

    es.addEventListener("done", async (ev) => {
      stopStream();
      const data = JSON.parse(ev.data || "{}");

      if (data?.ok === false) {
        setStatus("‚ùå " + (data?.error || data?.message || "Run failed"), "err");
        $("out").textContent = JSON.stringify(data, null, 2);
        return;
      }

      lastFinalDoc = data?.finalDoc || null;

      if (!lastFinalDoc) {
        setStatus("Done, but no finalDoc returned.", "warn");
        $("out").textContent = JSON.stringify(data, null, 2);
        return;
      }

      setStatus("‚úÖ Preview complete", "ok");
      appendLog("‚úÖ Done.");
      await renderPreview(lastFinalDoc);

      $("copyBtn").disabled = false;
      $("publishBtn").disabled = false;
    });

    es.addEventListener("agent_error", (ev) => {
      stopStream();
      const data = JSON.parse(ev.data || "{}");
      const msg = data?.message || "Stream error";
      setStatus("‚ùå " + msg, "err");
      appendLog("‚ùå " + msg);
    });

    es.onerror = () => {
      stopStream();
      setStatus("‚ùå Stream error (see server logs).", "err");
      appendLog("‚ùå Stream error (see server logs).");
    };
  }

  async function publish(p) {
  if (!lastFinalDoc) {
  setStatus("Run Preview / Load Audit / Chat update first so there is something to publish.", "warn");
  return;
}


  $("publishBtn").disabled = true;
  setStatus("Publishing‚Ä¶", "info");
  appendLog("‚Ä¢ Publishing‚Ä¶");

  try {
    const resp = await fetch("/admin/agent/publish", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({
  countryName: p.countryName,
  auditId: lastAuditId,
  finalDoc: lastFinalDoc
})

    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || data?.ok === false) {
      const msg = data?.error || data?.message || `Publish failed (${resp.status})`;
      setStatus("‚ùå " + msg, "err");
      appendLog("‚ùå " + msg);
      $("out").textContent = JSON.stringify(data, null, 2);
      $("publishBtn").disabled = false;
      return;
    }

    setStatus("‚úÖ Published", "ok");
    appendLog("‚úÖ Published.");
  } catch (e) {
    setStatus("‚ùå " + (e?.message || "Unknown error"), "err");
    appendLog("‚ùå " + (e?.message || "Unknown error"));
    $("publishBtn").disabled = false;
  }
}


  async function loadCountries() {
    try {
      const res = await fetch("/admin/agent/countries", { headers: { "Accept": "application/json" } });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Failed to load countries");

      const sel = $("countryName");
      sel.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a destination country‚Ä¶";
      sel.appendChild(placeholder);

      (data.countries || []).forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });

      setStatus("Countries loaded.", "ok");
      $("meta").textContent = "(none)";
    } catch (e) {
      setStatus("Failed to load countries: " + e.message, "err");
      $("countryName").innerHTML = '<option value="">(error loading countries)</option>';
    }
  }

  function chatAdd(role, text) {
    const wrap = $("chatThread");
    const div = document.createElement("div");
    div.className = "mb-2";
    div.innerHTML = `<div class="small text-muted">${role}</div><div>${String(text).replaceAll("\n","<br>")}</div>`;
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
  }

  async function uploadPdfToAgent(file) {
  const p = getFormPayload();
  if (!p.countryName) {
    setStatus("Pick a country before uploading PDFs.", "warn");
    return;
  }

  const statusEl = $("pdfUploadStatus");
  statusEl.textContent = "Uploading PDF‚Ä¶";

  const fd = new FormData();
  fd.append("pdf", file);
  fd.append("countryName", p.countryName);
  if (lastAuditId) fd.append("auditId", lastAuditId);

  try {
    const resp = await fetch("/admin/agent/upload-pdf", {
      method: "POST",
      body: fd
    });

    const data = await resp.json();

    if (!resp.ok || data?.ok === false) {
      statusEl.textContent = "‚ùå PDF upload failed: " + (data?.error || resp.status);
      return;
    }

    // Success
    statusEl.textContent = `‚úÖ Uploaded: ${data.filename}`;
    chatAdd(
      "System",
      `üìÑ PDF uploaded and indexed: <a href="${data.publicUrl}" target="_blank">${data.filename}</a>`
    );
  } catch (e) {
    statusEl.textContent = "‚ùå PDF upload error";
    console.error(e);
  }
}


  async function sendChat() {
    const p = getFormPayload();
    const msg = ($("chatInput").value || "").trim();
    if (!msg) return;

    chatAdd("You", msg);
    $("chatInput").value = "";
    $("chatSendBtn").disabled = true;
    $("chatHints").textContent = "Thinking‚Ä¶";

    try {
  const resp = await fetch("/admin/agent/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Accept": "application/json" },
    body: JSON.stringify({
      countryName: p.countryName,
      researchMode: p.researchMode,
      manualUrls: p.manualUrls,
      auditId: lastAuditId,
      finalDoc: lastFinalDoc,
      message: msg
    })
  });

  const data = await resp.json();

  if (!resp.ok || data?.ok === false) {
    setStatus(data?.error || "Chat update failed", "err");
    return;
  }

  // ‚úÖ Update in-memory doc + preview without rerun
  if (data?.finalDoc) {
    lastFinalDoc = data.finalDoc;
    if (data?.auditId) lastAuditId = data.auditId;

    await renderPreview(lastFinalDoc);

    $("copyBtn").disabled = false;
    $("publishBtn").disabled = false;
  }

  if (data?.replyMarkdown) chatAdd("Agent", data.replyMarkdown);

  setStatus("‚úÖ Updated from chat (no rerun needed)", "ok");
  $("chatInput").value = "";

  lastSuggestedUrls = Array.isArray(data.suggestedUrls) ? data.suggestedUrls : [];
  $("applyUrlsBtn").disabled = lastSuggestedUrls.length === 0;

  const hints = [];
  if (Array.isArray(data.missingOrUnclear) && data.missingOrUnclear.length) {
    hints.push("Missing/unclear:\n- " + data.missingOrUnclear.join("\n- "));
  }
  if (Array.isArray(data.suggestedSearchTerms) && data.suggestedSearchTerms.length) {
    hints.push("Search terms:\n- " + data.suggestedSearchTerms.join("\n- "));
  }
  if (data.nextInstructions) hints.push("Next:\n" + data.nextInstructions);

  $("chatHints").textContent = hints.join("\n\n");
} catch (e) {
  chatAdd("Agent", "Chat error: " + (e?.message || "unknown"));
  $("chatHints").textContent = "";
} finally {
  $("chatSendBtn").disabled = false;
}

  }

  $("runBtn")?.addEventListener("click", async () => {
  const reuse = $("reuseAuditToggle")?.checked;

  if (reuse) {
    const doc = await loadLastAudit();
    if (doc) await renderPreview(doc);
    return;
  }

  await runPreviewSSE(getFormPayload());
});

$("loadAuditBtn")?.addEventListener("click", async () => {
  const doc = await loadLastAudit();
  if (doc) await renderPreview(doc);
});


  $("stopBtn")?.addEventListener("click", () => {
    stopStream();
    setStatus("Stopped.", "warn");
    appendLog("‚ö†Ô∏è Stopped by user.");
  });

  $("publishBtn")?.addEventListener("click", async () => {
    await publish(getFormPayload());
  });

  $("copyBtn")?.addEventListener("click", async () => {
    if (!lastFinalDoc) return;
    await navigator.clipboard.writeText(JSON.stringify(lastFinalDoc, null, 2));
    setStatus("Copied finalDoc JSON to clipboard.", "ok");
  });

  $("chatSendBtn")?.addEventListener("click", sendChat);

  $("applyUrlsBtn")?.addEventListener("click", () => {
    if (!lastSuggestedUrls.length) return;
    const current = ($("manualUrls").value || "").trim();
    const existing = new Set(current.split(/\r?\n/).map(s => s.trim()).filter(Boolean));
    lastSuggestedUrls.forEach(u => existing.add(u));
    $("manualUrls").value = Array.from(existing).join("\n");
    setStatus("‚úÖ Applied suggested URLs to Manual URLs.", "ok");
  });

  $("pdfUploadInput")?.addEventListener("change", (ev) => {
  const file = ev.target.files?.[0];
  if (!file) return;

  if (file.type !== "application/pdf") {
    setStatus("Only PDF files are supported.", "warn");
    ev.target.value = "";
    return;
  }

  uploadPdfToAgent(file);
  ev.target.value = ""; // allow re-upload of same file later
});


  loadCountries();
</script>
