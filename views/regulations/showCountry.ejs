<% layout('layouts/boilerplate') %>

<%
  // ---- safe date formatter (avoids "Invalid Date") ----
  function fmtDate(val) {
    if (!val) return '';
    const dt = new Date(val);
    return isNaN(dt) ? '' : dt.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
  }

  // ✅ Ads module helpers (comes from your middleware.attachAds)
  const hasGetAd = (typeof getAd === 'function');
  const safeGetAd = hasGetAd ? getAd : (() => null);

  // ✅ choose the placement you want to show INSIDE this page’s right container
  const RIGHT_CARD_TOP_PLACEMENT = 'inline-grid-2';

  // ✅ a safe DOM id helper (avoid commas/spaces breaking ids/selectors)
  //    (keeps it deterministic + readable)
  function domId(str) {
    return String(str || '')
      .trim()
      .toLowerCase()
      .replace(/&/g, 'and')
      .replace(/[^a-z0-9]+/g, '_')
      .replace(/^_+|_+$/g, '');
  }
%>

<div class="bg-light py-5 text-center border-bottom">
  <h1 class="fw-bold display-5">Compare Pet Travel Policies Easily</h1>
  <p class="fs-5 text-muted">Select your countries and pet type to see import/export rules instantly.</p>

  <!-- Navigation Strip -->
  <div class="mt-4">
    <!-- Desktop Layout -->
    <div class="d-none d-md-flex justify-content-center gap-3 flex-wrap desktop-icon-nav">
      <a href="/getCountryRegulationList"  class="btn btn-dark px-4 py-2 text-center">
        <i class="bi bi-globe-americas d-block fs-3"></i>
        <small>Country Policies</small>
      </a>
      <a href="/regulations/searchFlights" class="btn btn-outline-secondary px-4 py-2 text-center">
        <i class="bi bi-airplane d-block fs-3"></i>
        <small>Search Flights</small>
      </a>
      <a href="/regulations/airlineList" class="btn btn-outline-secondary px-4 py-2 text-center">
        <i class="bi bi-card-list d-block fs-3"></i>
        <small>Airline Policies</small>
      </a>
      <a href="/findAVet" class="btn btn-outline-secondary px-4 py-2 text-center">
        <i class="bi bi-hospital d-block fs-3"></i>
        <small>Find a Vet</small>
      </a>
      <a href="/blog" class="btn btn-outline-secondary px-4 py-2 text-center">
        <i class="bi bi-journal-text d-block fs-3"></i>
        <small>Blog</small>
      </a>
    </div>

    <!-- Mobile Layout -->
    <div class="d-flex d-md-none justify-content-between text-center mt-3 px-2">
      <div class="mobile-icon-group">
        <a href="/getCountryRegulationList" class="square-icon btn btn-dark">
          <i class="bi bi-globe-americas fs-3"></i>
        </a>
        <small>Country</small>
      </div>
      <div class="mobile-icon-group">
        <a href="/regulations/searchFlights" class="square-icon btn btn-outline-secondary">
          <i class="bi bi-airplane fs-3"></i>
        </a>
        <small>Flights</small>
      </div>
      <div class="mobile-icon-group">
        <a href="/regulations/airlineList" class="square-icon btn btn-outline-secondary">
          <i class="bi bi-card-list fs-3"></i>
        </a>
        <small>Airlines</small>
      </div>
      <div class="mobile-icon-group">
        <a href="/findAVet" class="square-icon btn btn-outline-secondary">
          <i class="bi bi-hospital fs-3"></i>
        </a>
        <small>Vet</small>
      </div>
      <div class="mobile-icon-group">
        <a href="/blog" class="square-icon btn btn-outline-secondary">
          <i class="bi bi-journal-text fs-3"></i>
        </a>
        <small>Blog</small>
      </div>
    </div>
  </div>
</div>

<!-- Styled Regulation Summary Box -->
<div class="container my-5">
  <div style="display: flex; flex-direction: column; align-items: center; margin: 20px 0;">
      <% const headerAd = (typeof getAd === 'function') ? getAd('header') : null; %>
      <% if (headerAd) { %>
        <%- include('../partials/ads/ad-image', { ad: headerAd }) %>
      <% } %>
  </div>

  <!-- Country Header -->
  <% if (regulations?.destinationCountry?.trim()) { %>
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-geo-alt-fill me-2"></i><%- regulations.destinationCountry %>
    </h2>

    <%
      const created = regulations.createdAt || regulations.timestamp || null;
      const updated = regulations.updatedAt || null;

      const hasTrueUpdate =
        created && updated && (new Date(updated).getTime() > new Date(created).getTime());

      const dbUpdated = hasTrueUpdate ? fmtDate(updated) : null;

      const sourceUpdated = regulations.sourceLastModified ? fmtDate(regulations.sourceLastModified) : null;
      const sourceNote = (regulations.sourceLastModifiedNote || '').trim();
    %>

    <% if (dbUpdated || sourceUpdated || sourceNote) { %>
      <div class="small text-muted mt-2">
        <% if (dbUpdated) { %>
          <span class="me-3"><strong>PetVoyage updated:</strong> <%= dbUpdated %></span>
        <% } %>

        <% if (sourceUpdated) { %>
          <span class="me-3"><strong>Source last modified:</strong> <%= sourceUpdated %></span>
        <% } %>

       
      </div>
    <% } %>

    <hr class="w-25 mx-auto opacity-75">
  </div>
  <% } %>

  <!-- Save Country Button -->
  <div class="text-center mt-3 mb-2">
    <form method="POST" action="/favorites/saveToProfile" class="d-inline">
      <input type="hidden" name="regulationId" value="<%= regulationId %>">
      <button type="submit" class="btn btn-outline-danger fw-semibold">
        <i class="fas fa-heart me-1"></i> Save
      </button>
    </form>
  </div>

  

  <!-- Pet Types Label -->
  <p class="text-muted fw-semibold mb-2 text-center">Pet Types</p>

  <!-- Pet Type Badges (canonical slug comes from route) -->
  <% if (petTypes && petTypes.length) { %>
    <div class="d-flex flex-wrap justify-content-center gap-2" id="petTypeSelector">
      <% petTypes.forEach((p) => { %>
        <button
          type="button"
          class="btn btn-outline-dark rounded-pill px-3 py-2 text-capitalize pet-type-btn <%= p.key === selectedPetType ? 'active' : '' %>"
          data-pet="<%= p.key %>"
          data-pet-slug="<%= p.slug %>">
          <i class="bi bi-paw-fill me-1"></i><%= p.key %>
        </button>
      <% }) %>
    </div>
  <% } %>

  <!-- Per-Pet Regulation Details -->
  <% Object.entries(regulations.regulationsByPetType || {}).forEach(([pet, details]) => { %>
    <% if (!details || !Object.keys(details).length) return; %>

    <%
      // ✅ Safe for DOM ids/selectors
      const petDom = domId(pet);
    %>

    <div class="pet-regulation-section"
         data-pet="<%= pet %>"
         data-pet-dom="<%= petDom %>"
         style="<%= pet === selectedPetType ? '' : 'display:none;' %>">

      <h3 class="text-primary text-center text-capitalize mb-4">
        <i class="bi bi-paw-fill me-2"></i><%= pet %> Regulations
      </h3>

      <!-- Banner Ad Section -->
      <%
        const petTypeLower = selectedPetType ? selectedPetType.toLowerCase() : '';
        let imgSrc = '', titleText = '', linkUrl = '';
        switch (petTypeLower) {
          case 'dog':  imgSrc = '/images/DogTravelCollectionV2.jpg'; titleText = 'Shop Dog Travel Supplies'; linkUrl = 'https://petsvoyage.myshopify.com/collections/dog-travel'; break;
          case 'cat':  imgSrc = '/images/CatTravelCollection.jpg';   titleText = 'Shop Cat Travel Supplies'; linkUrl = 'https://petsvoyage.myshopify.com/collections/cat-travel'; break;
          case 'bird': imgSrc = '/images/BirdTravelCollection.jpg';  titleText = 'Shop Bird Travel Supplies'; linkUrl = 'https://petsvoyage.myshopify.com/collections/bird-travel'; break;
          default:     imgSrc = '/images/OtherTravelCollection.jpg'; titleText = 'Shop Pet Travel Supplies'; linkUrl = 'https://petsvoyage.myshopify.com/collections/other-travel';
        }
      %>

    

      <% if (selectedPetType) { %>
        <div class="card shadow-sm border border-warning overflow-hidden mb-5" style="border-radius: 12px;">
          <div class="row align-items-center p-2">
            <div class="col-md-3 d-flex justify-content-center">
              <img src="<%= imgSrc %>" alt="<%= titleText %>" style="width: 80%; max-width: 200px; border-radius: 12px;">
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-center text-md-start text-center">
              <h3 class="fw-bold mb-3"><%= titleText %></h3>
              <p class="text-muted mb-0">Find airline-approved carriers, travel crates, harnesses, medical kits, and everything you need for stress-free pet travel.</p>
            </div>
            <div class="col-md-3 d-flex justify-content-md-end justify-content-center mt-3 mt-md-0">
              <a href="<%= linkUrl %>" target="_blank" rel="noopener noreferrer" class="btn btn-primary fw-bold px-4 py-2"> Shop Now → </a>
            </div>
          </div>
        </div>
      <% } %>

      <div class="row gy-4">

        <!-- Vaccinations -->
        <div class="col-md-6">
          <div class="card border-start border-dark border-4 shadow-sm h-100">
            <div class="card-body">
              <h5 class="fw-bold card-title text-dark">
                <i class="bi bi-shield-plus me-2"></i>Vaccinations
              </h5>

              <%
                const vaccinationKeys = Object.keys(details?.vaccinations || {}).filter(key => {
                  const vac = details.vaccinations[key];
                  return vac?.description?.trim() ||
                    (Array.isArray(vac?.requirements) && vac.requirements.some(r => String(r).trim()));
                });

                // build stable ids
                const vacPrefix = `vaccination__${petDom}__`;
              %>

              <% if (vaccinationKeys.length) { %>
                <div class="mb-3 d-flex flex-wrap gap-2">
                  <% vaccinationKeys.forEach((key, j) => {
                       const keyDom = domId(key);
                       const targetId = `${vacPrefix}${keyDom}`;
                  %>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary vac-btn <%= j === 0 ? 'active' : '' %>"
                      data-target="<%= targetId %>"
                      data-group="<%= vacPrefix %>">
                      <%= key %>
                    </button>
                  <% }) %>
                </div>

                <% vaccinationKeys.forEach((key, j) => {
                     const vac = details.vaccinations[key];
                     const keyDom = domId(key);
                     const targetId = `${vacPrefix}${keyDom}`;
                %>
                  <div id="<%= targetId %>"
                       class="vaccination-detail"
                       style="<%= j === 0 ? '' : 'display:none;' %>">
                    <% if (vac.description?.trim()) { %>
                      <div class="mb-2"><strong>Description:</strong> <%- vac.description %></div>
                    <% } %>
                    <% if (Array.isArray(vac.requirements) && vac.requirements.filter(r => String(r).trim()).length) { %>
                      <ul>
                        <% vac.requirements.filter(r => String(r).trim()).forEach(req => { %>
                          <li><%- req %></li>
                        <% }) %>
                      </ul>
                    <% } %>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted">Not specified.</p>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Certifications -->
        <div class="col-md-6">
          <div class="card border-start border-dark border-4 shadow-sm h-100">
            <div class="card-body">
              <h5 class="fw-bold card-title text-dark">
                <i class="bi bi-patch-check-fill me-2"></i>Certifications
              </h5>

              <%
                const rightTopAd = safeGetAd(RIGHT_CARD_TOP_PLACEMENT);
              %>
              <% if (rightTopAd) { %>
                <div class="mb-3">
                  <%- include('../partials/ads/ad-image', { ad: rightTopAd }) %>
                </div>
              <% } %>

              <%
                const certKeys = Object.keys(details?.certifications || {}).filter(key => {
                  const cert = details.certifications[key];
                  return cert?.description?.trim() ||
                    (Array.isArray(cert?.requirements) && cert.requirements.some(r => String(r).trim()));
                });

                const certPrefix = `certification__${petDom}__`;
              %>

              <% if (certKeys.length) { %>
                <div class="mb-3 d-flex flex-wrap gap-2">
                  <% certKeys.forEach((key, j) => {
                       const keyDom = domId(key);
                       const targetId = `${certPrefix}${keyDom}`;
                  %>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-success cert-btn <%= j === 0 ? 'active' : '' %>"
                      data-target="<%= targetId %>"
                      data-group="<%= certPrefix %>">
                      <%= key %>
                    </button>
                  <% }) %>
                </div>

                <% certKeys.forEach((key, j) => {
                     const cert = details.certifications[key];
                     const keyDom = domId(key);
                     const targetId = `${certPrefix}${keyDom}`;
                %>
                  <div id="<%= targetId %>"
                       class="certification-detail"
                       style="<%= j === 0 ? '' : 'display:none;' %>">
                    <% if (cert.description?.trim()) { %>
                      <div class="mb-2"><strong>Description:</strong> <%- cert.description %></div>
                    <% } %>
                    <% if (Array.isArray(cert.requirements) && cert.requirements.filter(r => String(r).trim()).length) { %>
                      <ul>
                        <% cert.requirements.filter(r => String(r).trim()).forEach(req => { %>
                          <li><%- req %></li>
                        <% }) %>
                      </ul>
                    <% } %>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted">Not specified.</p>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Microchip -->
        <% if (details?.microchip?.trim()) { %>
          <div class="col-md-6">
            <div class="card border-start border-dark border-4 shadow-sm h-100">
              <div class="card-body">
                <h5 class="fw-bold card-title text-dark">
                  <i class="bi bi-cpu me-2"></i>Microchip
                </h5>
                <div class="card-text"><%- details.microchip %></div>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Origin Requirements -->
        <div class="col-md-6">
          <div class="card border-start border-dark border-4 shadow-sm h-100">
            <div class="card-body">
              <h5 class="fw-bold card-title text-dark">
                <i class="bi bi-cpu me-2"></i>Origin Requirements
              </h5>
              <div class="card-text">
                <% if (originReqs && originReqs.length && originReqs.some(or => or.details?.trim())) { %>
                  <ul class="list-unstyled mb-0">
                    <% originReqs.filter(or => or.details?.trim()).forEach(or => { %>
                      <li class="mb-3">
                        <strong class="d-block"><%= or.key.replace(/-/g, ' ') %></strong>
                        <div class="mt-1"><%- or.details %></div>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="text-muted mb-0">No origin-specific requirements for this pet.</p>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- More Info -->
        <%
          const mi = details?.moreInfo;
          const miIsString = (typeof mi === 'string');
          const miIsObject = (mi && typeof mi === 'object' && !Array.isArray(mi));

          const miHasContent =
            (miIsString && mi.trim().length > 0) ||
            (miIsObject && Object.keys(mi).length > 0);
        %>

        <% if (miHasContent) { %>
          <div class="col-12">
            <div class="card border-start border-dark border-4 shadow-sm">
              <div class="card-body">
                <h5 class="card-title text-secondary">
                  <i class="bi bi-info-circle-fill me-2"></i>More Info
                </h5>

                <% if (miIsString) { %>
                  <div class="card-text"><%- mi %></div>
                <% } else { %>
                  <% Object.entries(mi).forEach(([sectionName, entry]) => {
                       const desc = entry?.description || '';
                       const reqs = Array.isArray(entry?.requirements) ? entry.requirements : [];
                  %>
                    <div class="mb-3">
                      <h6 class="fw-bold mb-1"><%= sectionName %></h6>

                      <% if (String(desc).trim()) { %>
                        <div class="card-text mb-2"><%- desc %></div>
                      <% } %>

                      <% if (reqs.length) { %>
                        <ul class="mb-0">
                          <% reqs.filter(r => String(r).trim()).forEach(r => { %>
                            <li><%= r %></li>
                          <% }) %>
                        </ul>
                      <% } %>
                    </div>
                  <% }) %>
                <% } %>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Import-Specific Links -->
        <% if (Array.isArray(details?.links) && details.links.some(link => link && (link.name || link.url))) { %>
          <div class="col-12">
            <div class="card bg-light shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-success"><i class="bi bi-journal-code me-2"></i>Import-Specific Links</h5>
                <% details.links.forEach(link => { %>
                  <% if (typeof link === 'object' && link.name && link.url) { %>
                    <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline-success mb-2 me-2"><%= link.name %></a>
                  <% } else if (typeof link === 'string' && link.trim()) { %>
                    <a href="<%= link %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline-success mb-2 me-2">Visit Link</a>
                  <% } %>
                <% }) %>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Official Links -->
        <% if (Array.isArray(regulations?.officialLinks) && regulations.officialLinks.some(link => link && (link.name || link.url))) { %>
          <div class="col-12">
            <div class="card bg-light shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-primary"><i class="bi bi-link-45deg me-2"></i>Official Source(s)</h5>
                <% regulations.officialLinks.forEach(link => { %>
                  <% if (typeof link === 'object' && link.name && link.url) { %>
                    <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary mb-2 me-2"><%= link.name %></a>
                  <% } else if (typeof link === 'string' && link.trim()) { %>
                    <a href="<%= link %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary mb-2 me-2">Visit Source</a>
                  <% } %>
                <% }) %>
              </div>
            </div>
          </div>
        <% } %>

      </div>
    </div>
  <% }) %>

  <!-- Expedia Script Ad -->
  <script async src="https://tpemd.com/content?trs=361070&shmarker=582248&tab=H%2CFH%2CCA&background=1&overlay=000000&button_color=FFCB00&target=1&powered_by=true&campaign_id=594&promo_id=8682" charset="utf-8"></script>
</div>

<br>
<p></p>

<!-- ✅ Pet Type Click => canonical slug (prevents duplicate URL variants) -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.pet-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const petSlug = btn.dataset.petSlug;
        if (!petSlug) return;

        const url = new URL(window.location.href);
        url.searchParams.set('petType', petSlug);
        window.location.href = url.toString();
      });
    });
  });
</script>

<!-- ✅ Vaccination/Certification Toggle Logic (safe; no split('-'), safe ids) -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    function activateButton(btn, selector) {
      const parent = btn.parentElement;
      if (!parent) return;
      parent.querySelectorAll(selector).forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    // Vaccinations
    document.querySelectorAll('.vac-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const prefix = btn.dataset.group;
        const target = btn.dataset.target;
        if (!prefix || !target) return;

        document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => el.style.display = 'none');
        const el = document.getElementById(target);
        if (el) el.style.display = 'block';

        activateButton(btn, '.vac-btn');
      });
    });

    // Certifications
    document.querySelectorAll('.cert-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const prefix = btn.dataset.group;
        const target = btn.dataset.target;
        if (!prefix || !target) return;

        document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => el.style.display = 'none');
        const el = document.getElementById(target);
        if (el) el.style.display = 'block';

        activateButton(btn, '.cert-btn');
      });
    });
  });
</script>
