<% layout('layouts/boilerplate') %>

<!-- Header / Hero -->
<header class="bg-light py-2 border-bottom" role="banner">
  <div class="container text-center">
    <img
      src="/images/PetVoyageLogo.png"
      class="img-fluid d-block mx-auto"
      alt="PetVoyage Logo — pet travel regulations and stories"
      width="200" height="200"
      loading="eager" decoding="async"
    />
    <h1 class="fw-bold display-5">Pet Travel Stories from Real Flyers</h1>
    <p class="fs-5 text-muted">Share and explore real flight stories with pets.</p>

    <nav class="mt-3" aria-label="Primary">
      <%- include('../partials/navigation') %>
    </nav>

    <div class="mt-4">
      <% if (user) { %>
        <a class="btn btn-primary" href="/blog/new" rel="nofollow">Write a story</a>
      <% } else { %>
        <a class="btn btn-outline-primary" href="/auth/login" rel="nofollow">Sign in to write a story</a>
      <% } %>
    </div>
  </div>
</header>

<main class="container mt-4" role="main" itemscope itemtype="https://schema.org/Blog">
  <meta itemprop="name" content="PetVoyage Community Blog">
  <meta itemprop="description" content="Community stories about flying with pets: tips, airline experiences, documents, and arrivals.">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Blog</li>
    </ol>
  </nav>

  <%
    // Build unique, sorted lists for filters from the current stories
    const airlinesSet = new Set();
    const countriesSet = new Set();
    (stories || []).forEach(s => {
      if (s.airline)  airlinesSet.add(String(s.airline).trim());
      if (s.country)  countriesSet.add(String(s.country).trim());
    });
    const airlinesList = Array.from(airlinesSet).sort((a,b) => a.localeCompare(b));
    const countriesList = Array.from(countriesSet).sort((a,b) => a.localeCompare(b));
  %>

  <div class="row">
    <!-- Sidebar Filters + Browse Lists -->
    <!-- Sidebar Filters + Browse Lists -->
<aside class="col-lg-3 mb-4" aria-label="Filters">

  <!-- Mobile toggle button -->
  <button
    class="btn btn-outline-secondary w-100 d-lg-none mb-2"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#pv-filter-panel"
    aria-expanded="false"
    aria-controls="pv-filter-panel">
    Filters
  </button>

  <!-- Collapsible panel on mobile; always visible on lg+ -->
  <div id="pv-filter-panel" class="collapse d-lg-block">
    <div class="card shadow-sm sticky-lg-top" style="top:1rem;">
      <div class="card-body">
        <h2 class="h5 mb-3 d-none d-lg-block">Filter stories</h2>

        <div class="mb-3">
          <label for="pv-search" class="form-label">Search title/summary</label>
          <input id="pv-search" type="search" class="form-control" placeholder="Type to filter…">
        </div>

        <div class="mb-3">
          <label class="form-label">Airline</label>
          <select id="pv-airline" class="form-select">
            <option value="">All airlines</option>
            <% airlinesList.forEach(a => { %>
              <option value="<%= a %>"><%= a %></option>
            <% }) %>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Country</label>
          <select id="pv-country" class="form-select">
            <option value="">All countries</option>
            <% countriesList.forEach(c => { %>
              <option value="<%= c %>"><%= c %></option>
            <% }) %>
          </select>
        </div>

        <!-- Active filter breadcrumbs -->
        <div class="mb-2" id="pv-crumbs" aria-live="polite"></div>

        <div class="d-flex gap-2 mb-2">
          <button id="pv-clear" class="btn btn-outline-secondary btn-sm" type="button">Clear</button>
        </div>

        <hr class="my-3">

        <!-- Browse by Airline -->
        <h3 class="h6 mb-2">Browse by airline</h3>
        <nav id="pv-browse-airlines" class="small" aria-label="Browse by airline">
          <% if (airlinesList.length === 0) { %>
            <p class="text-muted mb-2">No airline tags yet.</p>
          <% } else { %>
            <ul class="list-unstyled mb-3">
              <% airlinesList.forEach(a => { %>
                <li class="mb-1">
                  <a href="#" class="pv-link-airline" data-airline="<%= a %>"><%= a %></a>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </nav>

        <!-- Browse by Country -->
        <h3 class="h6 mb-2">Browse by country</h3>
        <nav id="pv-browse-countries" class="small" aria-label="Browse by country">
          <% if (countriesList.length === 0) { %>
            <p class="text-muted mb-0">No country tags yet.</p>
          <% } else { %>
            <ul class="list-unstyled mb-0">
              <% countriesList.forEach(c => { %>
                <li class="mb-1">
                  <a href="#" class="pv-link-country" data-country="<%= c %>"><%= c %></a>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </nav>

        <hr class="my-3">
        <p class="small text-muted mb-0" id="pv-count"><%= (stories||[]).length %> stories</p>
      </div>
    </div>
  </div>
</aside>


    <!-- Feed -->
    <div class="col-lg-9">
      <% if (!stories || !stories.length) { %>
        <div class="alert alert-info" role="status">No stories yet. Be the first to post!</div>
      <% } %>

      <div id="pv-list">
      <% (stories || []).forEach((story) => {
          const slug = story.slug || story._id;
          const url  = `/blog/${slug}`;
          const publishedISO = new Date(story.createdAt).toISOString();
          const publishedHuman = new Date(story.createdAt).toLocaleDateString();
          const plain = (story.body || '').replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
          const excerpt = plain.slice(0, 240);
          const airlineAttr = (story.airline || '').trim();
          const countryAttr = (story.country || '').trim();
      %>
        <article class="card border-secondary shadow p-4 mb-4 rounded-4 pv-card"
                 itemscope itemtype="https://schema.org/BlogPosting"
                 itemprop="blogPost"
                 data-airline="<%= airlineAttr %>"
                 data-country="<%= countryAttr %>"
                 data-text="<%= (story.title + ' ' + (story.summary||'') + ' ' + excerpt).toLowerCase().replace(/"/g,'&quot;') %>">
          <header>
            <h2 class="fw-bold mb-1" itemprop="headline">
              <a class="text-decoration-none" href="<%= url %>" itemprop="url"><%= story.title %></a>
            </h2>
            <div class="text-muted mb-3">
              <span itemprop="author" itemscope itemtype="https://schema.org/Person">
                by <span itemprop="name"><%= story.author?.displayName || 'Anonymous' %></span>
              </span>
              • <time itemprop="datePublished" datetime="<%= publishedISO %>"><%= publishedHuman %></time>
          <!-- inside the <header> ... -->
<% if (story.airline) { %>
  •
  <%
  const airlineKey = (story.airline || '').toLowerCase().trim();
  const airlineSlug = (airlineByName && airlineByName[airlineKey]) ? airlineByName[airlineKey] : '';
  const airlineHref = airlineSlug ? `/airlines/${airlineSlug}` : '';
%>


  <% if (airlineHref) { %>
    <a href="<%= airlineHref %>"
       class="badge text-bg-light border text-decoration-none d-inline-block"
       aria-label="View airline pet policy for <%= story.airline %>">
<i class="bi bi-airplane"></i> <%= story.airline %>

    </a>
  <% } else { %>
    <span class="badge text-bg-light border d-inline-block">
      <i class="bi bi-airplane"></i> <%= story.airline %>
    </span>
  <% } %>
<% } %>

              <% if (story.country) { %>
                • <span class="badge text-bg-light border">Country: <%= story.country %></span>
              <% } %>
            </div>
          </header>

          <% if (story.photos && story.photos[0]) { %>
            <a href="<%= url %>" aria-label="Open story: <%= story.title %>">
              <img
                src="<%= story.photos[0].url %>"
                class="img-fluid rounded-3 mb-3"
                alt="<%= story.photos[0].alt || (story.title + ' — pet travel photo') %>"
                loading="lazy" decoding="async" itemprop="image">
            </a>
          <% } %>

          <p class="fs-6 text-body mb-3" itemprop="description">
            <%= excerpt %><% if (plain.length > excerpt.length) { %>…<% } %>
          </p>

          <nav class="d-flex flex-wrap align-items-center gap-2" aria-label="Post actions">
  <a class="btn btn-outline-primary btn-sm" href="<%= url %>">
    Read full story
  </a>

  <!-- ✅ Favorite -->
  <form class="d-inline pv-fav-form"
        method="post"
        action="/blog/<%= slug %>/favorite"
        data-story-id="<%= slug %>">
    <button type="submit"
            class="btn btn-outline-danger btn-sm pv-fav-btn"
            aria-pressed="<%= story.isFavorited ? 'true' : 'false' %>"
            aria-label="<%= story.isFavorited ? 'Unfavorite' : 'Favorite' %> this story">
      <i class="bi <%= story.isFavorited ? 'bi-heart-fill' : 'bi-heart' %>"></i>
      <span class="pv-fav-count"><%= story.favoritesCount || 0 %></span>
    </button>
  </form>

  <!-- ✅ Comments link -->
  <a class="btn btn-outline-secondary btn-sm" href="<%= url %>#comments" aria-label="View comments">
    <i class="bi bi-chat-dots"></i>
    <%= story.commentsCount || 0 %>
  </a>

  <!-- ✅ Share -->
  <button type="button"
          class="btn btn-outline-secondary btn-sm pv-share-btn"
          data-share-url="<%= 'https://www.petvoyage.ai' + url %>"
          data-share-title="<%= (story.title || '').replace(/"/g,'&quot;') %>">
    <i class="bi bi-share"></i> Share
  </button>

  <% if (user && String(user._id) === String(story.author?._id || story.author)) { %>
    <a class="btn btn-outline-secondary btn-sm" href="/blog/<%= slug %>/edit" rel="nofollow">Edit</a>
    <form method="post" action="/blog/<%= slug %>/delete"
          onsubmit="return confirm('Delete this story?');" class="d-inline">
      <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
    </form>
  <% } %>
</nav>


          <meta itemprop="mainEntityOfPage" content="<%= 'https://www.petvoyage.ai' + url %>">
          <% if (story.summary) { %><meta itemprop="abstract" content="<%= story.summary %>"><% } %>
        </article>
      <% }) %>
      </div>
    </div>
  </div>

  <!-- JSON-LD: Blog -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": "PetVoyage Community Blog",
  "description": "Community stories about flying with pets.",
  "url": "https://www.petvoyage.ai/blog",
  "blogPost": [
    <% (stories || []).forEach(function(s, i){
         const slug = s.slug || s._id;
         const url = 'https://www.petvoyage.ai/blog/' + slug;
         const plain = (s.body || '').replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
         const excerpt = plain.slice(0, 240);
         const img = (s.photos && s.photos[0] && ('https://www.petvoyage.ai' + s.photos[0].url)) || '';
         const authorName = (s.author && s.author.displayName) ? s.author.displayName : 'Anonymous';
    %><%= i ? ',' : '' %>{
      "@type": "BlogPosting",
      "headline": <%- JSON.stringify(s.title || '') %>,
      "datePublished": "<%= new Date(s.createdAt).toISOString() %>",
      "url": "<%= url %>",
      "author": { "@type": "Person", "name": <%- JSON.stringify(authorName) %> },
      "image": <%- JSON.stringify(img) %>,
      "description": <%- JSON.stringify(excerpt) %>
    }<% }); %>
  ]
}
</script>

<!-- JSON-LD: ItemList -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Pet Travel Stories",
  "itemListElement": [
    <% (stories || []).forEach(function(s, i){
      const slug = s.slug || s._id;
      const url  = 'https://www.petvoyage.ai/blog/' + slug;
    %><%= i ? ',' : '' %>{
      "@type": "ListItem",
      "position": <%= i + 1 %>,
      "url": "<%= url %>"
    }<% }); %>
  ]
}
</script>

<!-- ✅ Favorites + Share (normal JS, NOT inside JSON-LD) -->
<script>
(() => {
  // ✅ Favorite toggle (AJAX). Falls back to normal POST if fetch fails.
  document.querySelectorAll('.pv-fav-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = form.querySelector('.pv-fav-btn');
      const countEl = form.querySelector('.pv-fav-count');

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });

        const ct = res.headers.get('content-type') || '';
        // If not logged in, you’ll likely get HTML (redirect) not JSON
        if (!ct.includes('application/json')) {
          window.location.href = '/auth/login';
          return;
        }

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Favorite failed');

        const isFav = !!data.favorited;
        btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
        btn.setAttribute('aria-label', (isFav ? 'Unfavorite' : 'Favorite') + ' this story');

        const icon = btn.querySelector('i');
        if (icon) {
          icon.classList.remove('bi-heart', 'bi-heart-fill');
          icon.classList.add(isFav ? 'bi-heart-fill' : 'bi-heart');
        }

        if (countEl) countEl.textContent = data.favoritesCount ?? 0;
      } catch (err) {
        form.submit(); // fallback
      }
    });
  });

  // ✅ Share
  document.querySelectorAll('.pv-share-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = btn.getAttribute('data-share-url') || window.location.href;
      const title = btn.getAttribute('data-share-title') || document.title;

      try {
        if (navigator.share) {
          await navigator.share({ title, url });
          return;
        }
      } catch (_) {}

      try {
        await navigator.clipboard.writeText(url);
        btn.innerHTML = '<i class="bi bi-check2"></i> Copied';
        setTimeout(() => { btn.innerHTML = '<i class="bi bi-share"></i> Share'; }, 1200);
      } catch (_) {
        window.prompt('Copy this link:', url);
      }
    });
  });
})();
</script>

</main>

<script>
(function(){
  const panel = document.getElementById('pv-filter-panel');

  function isMobile() { return window.matchMedia('(max-width: 991.98px)').matches; } // Bootstrap lg breakpoint
  function closePanelIfMobile() {
    if (!panel || !isMobile()) return;
    const inst = bootstrap?.Collapse.getOrCreateInstance(panel, { toggle: false });
    inst?.hide();
  }

  // Close after using selects, search, clear, or browse links
  ['pv-airline','pv-country','pv-search','pv-clear'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const evt = (id === 'pv-search') ? 'change' : 'click';
    el.addEventListener(evt, closePanelIfMobile);
  });

  document.querySelectorAll('.pv-link-airline, .pv-link-country').forEach(a => {
    a.addEventListener('click', closePanelIfMobile);
  });
})();
</script>

<script>
(() => {
  const $list     = document.getElementById('pv-list');
  const $cards    = Array.from($list?.querySelectorAll('.pv-card') || []);
  const $search   = document.getElementById('pv-search');
  const $airline  = document.getElementById('pv-airline');
  const $country  = document.getElementById('pv-country');
  const $clearBtn = document.getElementById('pv-clear');
  const $count    = document.getElementById('pv-count');
  const $crumbs   = document.getElementById('pv-crumbs');

  function normalize(s){ return (s || '').toLowerCase().trim(); }

  function renderCrumbs() {
    const parts = [];
    if ($airline && $airline.value) parts.push({type:'Airline', value: $airline.value, clear: () => {$airline.value='';} });
    if ($country && $country.value) parts.push({type:'Country', value: $country.value, clear: () => {$country.value='';} });
    if ($search && $search.value)   parts.push({type:'Search',  value: $search.value,  clear: () => {$search.value='';} });

    if (!$crumbs) return;
    if (parts.length === 0) { $crumbs.innerHTML = ''; return; }

    const html = [
      '<nav aria-label="Active filters"><span class="small me-2 text-muted">You’re viewing:</span>'
    ].concat(parts.map(p => `
      <span class="badge rounded-pill text-bg-light border me-1 mb-1">
        ${p.type}: ${p.value}
        <button type="button" class="btn btn-sm btn-link p-0 ms-1" aria-label="Clear ${p.type}" data-clear="${p.type}">×</button>
      </span>
    `)).concat('</nav>').join('');

    $crumbs.innerHTML = html;

    // Wire clear buttons
    $crumbs.querySelectorAll('[data-clear]').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = btn.getAttribute('data-clear');
        if (t === 'Airline') parts.find(p=>p.type==='Airline').clear();
        if (t === 'Country') parts.find(p=>p.type==='Country').clear();
        if (t === 'Search')  parts.find(p=>p.type==='Search').clear();
        applyFilters();
      });
    });
  }

  function applyFilters() {
    const q  = normalize($search?.value);
    const al = normalize($airline?.value);
    const co = normalize($country?.value);

    let visible = 0;

    $cards.forEach(card => {
      const cardAirline = normalize(card.getAttribute('data-airline'));
      const cardCountry = normalize(card.getAttribute('data-country'));
      const cardText    = normalize(card.getAttribute('data-text'));

      const passSearch  = !q  || cardText.includes(q);
      const passAirline = !al || cardAirline === al;
      const passCountry = !co || cardCountry === co;

      const show = passSearch && passAirline && passCountry;
      card.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if ($count) $count.textContent = visible + ' ' + (visible === 1 ? 'story' : 'stories');
    renderCrumbs();
  }

  // Sidebar link lists -> apply filter
  document.querySelectorAll('.pv-link-airline').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const val = a.getAttribute('data-airline') || '';
      if ($airline) $airline.value = val;
      applyFilters();
      document.getElementById('pv-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  document.querySelectorAll('.pv-link-country').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const val = a.getAttribute('data-country') || '';
      if ($country) $country.value = val;
      applyFilters();
      document.getElementById('pv-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  [$search, $airline, $country].forEach(el => {
    if (!el) return;
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });

  if ($clearBtn) {
    $clearBtn.addEventListener('click', () => {
      if ($search)  $search.value = '';
      if ($airline) $airline.value = '';
      if ($country) $country.value = '';
      applyFilters();
    });
  }

  applyFilters();
})();
</script>

