<% layout('layouts/boilerplate') %>

<%
  // Helpers for SEO-safe values
  const plainBody = String((story.body || '').replace(/<[^>]*>/g, ' ')).replace(/\s+/g,' ').trim();
  const summary160 = plainBody.slice(0, 160);
  const pageUrl = `/blog/${story.slug || story._id}`;
  const cover = (story.photos && story.photos[0] && story.photos[0].url) ? story.photos[0].url : '/images/blog-banner.jpg';
  const imgList = (story.photos || []).map(p => p.url).slice(0, 8);
  const authorName = (story.author && story.author.displayName) ? story.author.displayName : 'Anonymous';
  const publishedISO = new Date(story.createdAt).toISOString();
  const updatedISO = new Date(story.updatedAt || story.createdAt).toISOString();
%>

<div class="container my-4">
  <!-- Breadcrumb (helps internal linking + rich results) -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/blog">Blog</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= story.title %></li>
    </ol>
  </nav>

  <!-- Main article -->
  <article class="card border-secondary shadow p-4 rounded-4"
           itemscope itemtype="https://schema.org/BlogPosting">
    <header class="mb-2">
      <h1 class="fw-bold mb-1" itemprop="headline"><%= story.title %></h1>

      <div class="text-muted mb-2">
        by <span itemprop="author" itemscope itemtype="https://schema.org/Person">
          <span itemprop="name"><%= authorName %></span>
        </span>
        •
        <time itemprop="datePublished" datetime="<%= publishedISO %>"><%= new Date(story.createdAt).toLocaleDateString() %></time>
        <% if (updatedISO !== publishedISO) { %>
          <span class="visually-hidden">, updated </span>
          <meta itemprop="dateModified" content="<%= updatedISO %>">
        <% } %>
      <% if (story.airline) { %>
  •
  <% if (airlineDoc && airlineDoc.slug) { %>
    <a href="/airlines/<%= airlineDoc.slug %>"
       class="badge text-bg-light border text-decoration-none">
      <i class="bi bi-airplane"></i> <%= airlineDoc.name %>
    </a>
  <% } else { %>
    <span class="badge text-bg-light border"><%= story.airline %></span>
  <% } %>
<% } %>

      </div>

      <!-- Optional article meta block for scannability -->
      <% if (story.route || story.country || story.petType) { %>
        <ul class="list-inline small text-muted mb-0">
          <% if (story.route) { %><li class="list-inline-item">Route: <span itemprop="about"><%= story.route %></span></li><% } %>
          <% if (story.country) { %><li class="list-inline-item">Destination: <%= story.country %></li><% } %>
          <% if (story.petType) { %><li class="list-inline-item">Pet: <%= story.petType %></li><% } %>
        </ul>
      <% } %>

      <meta itemprop="mainEntityOfPage" content="<%= pageUrl %>">
      <meta itemprop="image" content="<%= cover %>">
      <meta itemprop="description" content="<%= summary160 %>">
      <span itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <meta itemprop="name" content="PetVoyage">
        <meta itemprop="logo" content="https://www.petvoyage.ai/images/PetVoyageLogo.png">
      </span>
    </header>

    <% if (story.photos && story.photos.length) { %>
  <style>
    .pv-story-photo {
      width: 100%;
      height: 220px;          /* consistent grid size */
      object-fit: cover;      /* crop nicely */
      display: block;
    }
  </style>

  <section class="row g-3 mb-3" aria-label="Story photos">
    <% story.photos.forEach(p => { 
         const full  = p.url;
         const thumb = p.thumbUrl || p.url;
    %>
      <div class="col-6 col-md-4">
        <figure class="mb-0">
          <a href="<%= full %>" target="_blank" rel="noopener">
            <img
              src="<%= thumb %>"
              class="img-fluid rounded-3 pv-story-photo"
              alt="<%= p.alt || story.title %>"
              loading="lazy">
          </a>
          <% if (p.alt) { %>
            <figcaption class="visually-hidden"><%= p.alt %></figcaption>
          <% } %>
        </figure>
      </div>
    <% }) %>
  </section>
<% } %>

<%
  const favCount = story.favoritesCount || (story.favoritedBy ? story.favoritedBy.length : 0) || 0;
  const isFav = !!story.isFavorited;
  const shareAbs = 'https://www.petvoyage.ai' + pageUrl;
%>

<div class="d-flex flex-wrap gap-2 my-3 align-items-center">
  <!-- ✅ Favorite -->
  <button
    class="btn btn-sm <%= isFav ? 'btn-primary' : 'btn-outline-primary' %> pv-fav-btn"
    type="button"
    data-story-id="<%= story.slug || story._id %>"
    aria-pressed="<%= isFav ? 'true' : 'false' %>">
    <i class="bi <%= isFav ? 'bi-heart-fill' : 'bi-heart' %>"></i>
    <span class="pv-fav-count"><%= favCount %></span>
    <span class="ms-1">Favorite</span>
  </button>

  <!-- ✅ Share -->
  <button
    class="btn btn-outline-secondary btn-sm pv-share-btn"
    type="button"
    data-share-url="<%= shareAbs %>"
    data-share-title="<%= story.title.replace(/"/g,'&quot;') %>">
    <i class="bi bi-share"></i> Share
  </button>

  <a class="btn btn-outline-secondary btn-sm" href="#comments">
    <i class="bi bi-chat-dots"></i>
    <%= (story.comments || []).length %> Comments
  </a>
</div>

    <!-- Body -->
    <section class="fs-5" itemprop="articleBody">
      <%- story.body %>
    </section>
<section id="comments" class="mt-5">
  <h2 class="h4 fw-bold mb-3">Comments</h2>

  <% if (user) { %>
    <form method="post" action="/blog/<%= story.slug || story._id %>/comments" class="mb-4">
      <div class="mb-2">
        <label for="comment" class="form-label">Add a comment</label>
        <textarea id="comment" name="comment" class="form-control" rows="3" maxlength="2000" required></textarea>
      </div>
      <button class="btn btn-primary">Post comment</button>
    </form>
  <% } else { %>
    <div class="alert alert-light border">
      <a href="/auth/login">Sign in</a> to comment.
    </div>
  <% } %>

  <% if (!story.comments || story.comments.length === 0) { %>
    <p class="text-muted">No comments yet.</p>
  <% } else { %>
    <div class="list-group">
      <% story.comments.slice().reverse().forEach(c => { %>
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">
                <%= (c.user && c.user.displayName) ? c.user.displayName : (c.displayName || 'Anonymous') %>
                <span class="text-muted fw-normal small ms-2">
                  <%= new Date(c.createdAt).toLocaleString() %>
                </span>
              </div>
              <div class="mt-2" style="white-space:pre-wrap;">
                <%= c.body %>
              </div>
            </div>

            <% const canDelete = user && (
                 String(story.author) === String(user._id) ||
                 String(c.user?._id || c.user) === String(user._id)
               ); %>

            <% if (canDelete) { %>
              <form method="post" action="/blog/<%= story.slug || story._id %>/comments/<%= c._id %>/delete"
                    onsubmit="return confirm('Delete this comment?');">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</section>

    <!-- Simple prev/next internal links can be added later for stronger crawl paths -->

    <footer class="mt-4 d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/blog" aria-label="Back to blog list">← Back to blog</a>
      <% if (user && String(user._id) === String(story.author)) { %>
        <a class="btn btn-primary" href="/blog/<%= story._id %>/edit">Edit</a>
        <form action="/blog/<%= story._id %>/delete" method="post" class="d-inline"
              onsubmit="return confirm('Delete this story?');">
          <button class="btn btn-danger">Delete</button>
        </form>
      <% } %>
    </footer>
  </article>
</div>

  <!-- Blog article HTML above -->
<!-- ✅ JSON-LD: BlogPosting (PUT IT HERE) -->
<script type="application/ld+json">
<%- JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "@id": ogUrl,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": ogUrl
  },
  "headline": story.title,
  "description": metaDescription,
  "url": ogUrl,
  "datePublished": story.createdAt,
  "dateModified": story.updatedAt || story.createdAt,
  "author": {
    "@type": "Person",
    "name": (story.author && story.author.displayName) || story.authorName || "PetVoyage"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PetVoyage",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.petvoyage.ai/images/PetVoyageLogo.png"
    }
  },
  "image": [ogImage]
}, null, 2) %>
</script>


<script>
(() => {
  const favBtn = document.querySelector('.pv-fav-btn');
  if (favBtn) {
    favBtn.addEventListener('click', async () => {
      const storyId = favBtn.getAttribute('data-story-id');
      try {
        const res = await fetch(`/blog/${storyId}/favorite`, {
          method: 'POST',
          headers: { 'Accept': 'application/json' }
        });

        if (res.status === 401) {
          window.location.href = '/auth/login';
          return;
        }

        const data = await res.json();
        if (!data.ok) return;

        const pressed = data.favorited;
        favBtn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
        favBtn.classList.toggle('btn-primary', pressed);
        favBtn.classList.toggle('btn-outline-primary', !pressed);

        const icon = favBtn.querySelector('i.bi');
        if (icon) {
          icon.classList.toggle('bi-heart-fill', pressed);
          icon.classList.toggle('bi-heart', !pressed);
        }

        const countEl = favBtn.querySelector('.pv-fav-count');
        if (countEl) countEl.textContent = data.favoritesCount;
      } catch (e) {
        console.warn('favorite failed', e);
      }
    });
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      return false;
    }
  }

  const shareBtn = document.querySelector('.pv-share-btn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const url = shareBtn.getAttribute('data-share-url');
      const title = shareBtn.getAttribute('data-share-title') || 'PetVoyage story';

      if (navigator.share) {
        try { await navigator.share({ title, url }); return; } catch {}
      }

      const ok = await copyToClipboard(url);
      shareBtn.textContent = ok ? 'Link copied!' : 'Copy failed';
      setTimeout(() => {
        shareBtn.innerHTML = '<i class="bi bi-share"></i> Share';
      }, 1200);
    });
  }
})();
</script>

