<!-- views/partials/chatGPT.ejs -->
<div class="card border-secondary shadow-lg p-3 mb-5 bg-white rounded"
     id="pv-ai-<%= idSuffix || 'one' %>">
  <div class="card-body">
    <h2 class="text-center text-secondary-emphasis mb-2"><strong>Plan Pet Travel</strong></h2>
    <p class="text-center text-muted mb-3">
      I‚Äôm <strong>Scout</strong> üêæ ‚Äî pick an airline, a destination country, and your pet type.
      I‚Äôll split results into <em>Airline</em> vs <em>Country (immigration)</em>, suggest a timeline,
      and let you save it to your dashboard.
    </p>

    <!-- Planner -->
    <form class="pv-plan-form" aria-label="Build your pet travel plan">
      <div class="mb-3">
        <label class="form-label">Airline</label>
        <select class="form-select pv-airline" required></select>
        <div class="form-text">Choose the carrier you‚Äôll fly. Policies can vary widely.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Destination Country</label>
        <select class="form-select pv-country" required></select>
        <div class="form-text">This determines the immigration/entry rules for your pet.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Pet Type</label>
        <select class="form-select pv-pet" required disabled>
          <option value="">Select country first to load available pet types‚Ä¶</option>
        </select>
        <div class="form-text">Pet types update based on the country you pick.</div>
      </div>

      <div class="text-center">
        <button class="btn btn-primary" type="submit">Get Requirements</button>
      </div>
    </form>

    <!-- Server returns a full, styled itinerary (with Save + Find Vet buttons). -->
    <div class="mt-4 pv-plan-results" style="display:none;"></div>

    <p class="text-muted small mt-3 mb-0">
      ‚ÑπÔ∏è I combine your database + official sources + AI. I‚Äôll clearly label anything I infer for you.
      Always confirm critical details with your airline and border authorities.
    </p>
  </div>
</div>

<script>
(function () {
  var suf = "<%= idSuffix || 'one' %>";
  var root = document.getElementById('pv-ai-' + suf);
  if (!root) return;

  // Elements
  var planForm   = root.querySelector('.pv-plan-form');
  var selAirline = root.querySelector('.pv-airline');
  var selCountry = root.querySelector('.pv-country');
  var selPet     = root.querySelector('.pv-pet');
  var resWrap    = root.querySelector('.pv-plan-results');

  function cap(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }
  function setPets(pets){
    const options = (pets||[]).map(function(p){ return '<option value="'+p+'">'+cap(p)+'</option>'; }).join('');
    selPet.innerHTML = '<option value="">Select pet</option>' + options;
    selPet.disabled = !(pets && pets.length);
  }

  // Load airlines + countries
  fetch('/ai/pet-check/options')
    .then(function(r){ return r.json(); })
    .then(function(data){
      var airlines = data.airlines || [];
      var countries = data.countries || [];

      selAirline.innerHTML = '<option value="">Select airline</option>' +
        airlines.map(function(a){
          return '<option value="'+a._id+'" data-code="'+(a.airlineCode||'')+'">'+a.name+(a.airlineCode?(' ('+a.airlineCode+')'):'')+'</option>';
        }).join('');

      selCountry.innerHTML = '<option value="">Select country</option>' +
        countries.map(function(c){ return '<option value="'+c+'">'+c+'</option>'; }).join('');

      setPets([]); // disabled until country chosen
    })
    .catch(function(e){
      console.error('options error', e);
      setPets([]);
    });

  // When country changes, fetch that country's pet types
  selCountry.addEventListener('change', function(){
    var c = selCountry.value;
    if (!c) { setPets([]); return; }
    selPet.disabled = true;
    selPet.innerHTML = '<option value="">Loading pets‚Ä¶</option>';
    fetch('/ai/pet-check/pet-types?country=' + encodeURIComponent(c))
      .then(function(r){ return r.json(); })
      .then(function(d){ setPets(d.petTypes || []); })
      .catch(function(){ setPets([]); });
  });

  // Submit: request server-built itinerary HTML and render it
  planForm.addEventListener('submit', async function(e){
    e.preventDefault();
    var airlineId   = selAirline.value;
    var airlineCode = selAirline.selectedOptions[0] && selAirline.selectedOptions[0].getAttribute('data-code');
    var country     = selCountry.value;
    var petType     = selPet.value;
    if (!airlineId || !country || !petType) return;

    resWrap.style.display = 'block';
    resWrap.innerHTML = '<div class="border rounded p-3 bg-light">Loading‚Ä¶</div>';

    try {
      var res = await fetch('/ai/pet-check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ airlineId: airlineId, airlineCode: airlineCode, country: country, petType: petType })
      });
      var data = await res.json();

      if (!res.ok || data.error) {
        resWrap.innerHTML = '<div class="alert alert-danger mb-0">' + (data.error || 'Lookup failed.') + '</div>';
        return;
      }

      // Render server HTML + actions
      resWrap.innerHTML = (data.html || '<div class="alert alert-warning mb-0">No details available.</div>') + `
        <div class="mt-3 d-flex flex-wrap gap-2">
          <button class="btn btn-success pv-save-itin">Save to my dashboard</button>
          <button class="btn btn-outline-secondary pv-find-vet">Find a nearby vet</button>
          ${data.airline && data.airline.petPolicyURL ? `<a class="btn btn-outline-primary" href="${data.airline.petPolicyURL}" target="_blank" rel="noopener">Airline Pet Policy</a>` : ``}
        </div>
      `;

      // Bind "Find a nearby vet"
      var vetBtn2 = resWrap.querySelector('.pv-find-vet');
      if (vetBtn2) {
        vetBtn2.addEventListener('click', function(ev){
          ev.preventDefault();
          if (!navigator.geolocation) { alert('Geolocation not available.'); return; }
          navigator.geolocation.getCurrentPosition(
            function(pos){
              var lat = pos.coords.latitude, lng = pos.coords.longitude;
              window.location.href = '/findAVet?lat='+lat+'&lng='+lng;
            },
            function(err){ alert('Could not get location: ' + err.message); },
            { enableHighAccuracy: true, timeout: 8000 }
          );
        });
      }

      // Bind "Save to my dashboard"
      var saveBtn = resWrap.querySelector('.pv-save-itin');
      if (saveBtn) {
        saveBtn.addEventListener('click', async function() {
          var itin = resWrap.querySelector('.pv-itinerary');
          if (!itin) { alert('Nothing to save.'); return; }

          var selected   = selAirline.selectedOptions[0];
          var airlineId  = selAirline.value || '';
          var airlineCode= (selected && selected.getAttribute('data-code')) || '';

          var payload = {
            airlineId: airlineId || undefined,
            airlineCode: airlineCode || undefined,
            airlineName: '',      // server will resolve if possible
            airlineSlug: '',
            petPolicyURL: '',
            country: selCountry.value,
            petType: selPet.value,
            html: itin.outerHTML
          };

          try {
            const r = await fetch('/favorites/saveItinerary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const j = await r.json();
            if (!r.ok) {
              alert(j.message || 'Could not save.');
              return;
            }
            const ok = document.createElement('div');
            ok.className = 'alert alert-success mt-3';
            ok.textContent = j.message || 'Saved.';
            resWrap.appendChild(ok);
            setTimeout(() => ok.remove(), 3000);
          } catch (e) {
            console.error('save itinerary failed', e);
            alert('Network error while saving.');
          }
        });
      }
    } catch (err) {
      console.error('lookup error', err);
      resWrap.innerHTML = '<div class="alert alert-danger mb-0">Network error.</div>';
    }
  });
})();
</script>
